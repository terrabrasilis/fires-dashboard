var graph={data:[],totalRows:0,bydata:"prodes",selectedBiome:"a",config:{},selectedFilters:{},ctlFirstLoading:!1,totalizedFocusesInfoBox:void 0,barMonthFiresByClass:null,ringTotalizedByState:void 0,histTopByCLs:void 0,palletBarChartProdes:["#c7f8e3","#9bf8d0","#49d398","#238b45"],palletBarChartCar:["#feebe2","#fbb4b9","#f768a1","#c51b8a","#7a0177"],palletPieChartProdes:["#fbb4ae","#b3cde3","#ccebc5","#decbe4","#fed9a6","#ffffcc","#e5d8bd","#fddaec","#f2f2f2"],palletPieChartCar:["#fbb4ae","#b3cde3","#ccebc5","#decbe4","#fed9a6","#ffffcc","#e5d8bd","#fddaec","#f2f2f2"],getOrdinalColorsClasses:function(){let c=[],cls=graph.config.dataConfig.legendOriginal[graph.bydata],cor="prodes"==graph.bydata?graph.palletBarChartProdes:graph.palletBarChartCar;for(let i=0;i<cls.length;i++)c.push({key:cls[i],color:cor[i]});return c},setConfigurations:function(conf){conf?(graph.palletBarChartProdes=conf.palletBarChartProdes?conf.palletBarChartProdes:graph.palletBarChartProdes,graph.palletPieChartProdes=conf.palletPieChartProdes?conf.palletPieChartProdes:graph.palletPieChartProdes,graph.palletBarChartCar=conf.palletBarChartCar?conf.palletBarChartCar:graph.palletBarChartCar,graph.palletPieChartCar=conf.palletPieChartCar?conf.palletPieChartCar:graph.palletPieChartCar,graph.defaultHeight=conf.defaultHeight?conf.defaultHeight:graph.utils.getDefaultHeight()):console.log("Didn't load config file. Using default options.")},init:function(config,data){0!=data.length&&void 0===data.exception?(Lang.apply(),graph.setConfigurations(config.dataConfig),this.loadData(!1,data)&&(this.displayWaiting(!1),this.config=config,this.totalizedFocusesInfoBox=dc.numberDisplay("#numpolygons"),this.barMonthFiresByClass=dc.barChart("#chart-bar-by-month-class"),this.ringTotalizedByState=dc.pieChart("#chart-ring-by-state"),this.histTopByCLs=dc.rowChart("#chart-hist-top-cls"),graph.build())):this.displayWarning(!0)},displayWaiting:function(enable){void 0===enable&&(enable=!0),d3.select("#charts-panel").style("display",enable?"none":""),d3.select("#loading_data_info").style("display",enable?"":"none"),d3.select("#info_container").style("display",enable?"":"none"),d3.select("#panel_container").style("display",enable?"none":""),d3.select("#warning_data_info").style("display","none")},displayWarning:function(enable){void 0===enable&&(enable=!0),document.getElementById("warning_data_info").style.display=enable?"":"none",document.getElementById("warning_data_info").innerHTML='<h3><span id="txt8">'+Translation[Lang.language].txt8+"</span></h3>",document.getElementById("loading_data_info").style.display=enable?"none":""},loadData:function(error,data){return error?(console.log(error),!1):(graph.totalRows=data.length,graph.data=data,graph.normalizeData(),!0)},startLoadData:function(){var afterLoadConfiguration=function(cfg){graph.displayWaiting();var configDashboard={resizeTimeout:0,minWidth:250,dataConfig:cfg};let dataUrl=downloadCtrl.getFileDeliveryURL()+"/download/"+downloadCtrl.getProject()+"/fof_"+graph.bydata;var afterLoadData=function(json){Lang.apply(),json&&json.features?(graph.init(configDashboard,json.features),graph.setUpdatedDate(json.updated_date)):graph.displayWarning(!0)};d3.json(dataUrl).header("Authorization","Bearer "+(Authentication?Authentication.getToken():"")).get((function(error,root){error&&401==error.status?console.error(error):afterLoadData(root)}))};d3.json("./config/"+downloadCtrl.getProject()+".json",afterLoadConfiguration)},setUpdatedDate:function(updated_date){var dt=new Date(updated_date+"T21:00:00.000Z");d3.select("#updated_date").html(" "+dt.toLocaleDateString())},setDataDimension:function(d){this.bydata=d,this.restart()},setBiome:function(link,d){$("[id^=toAggregatedChart]").removeClass("enable_menu"),$("#toAggregatedChart-"+link).addClass("enable_menu"),this.selectedBiome=d,this.restart()},utils:{mappingClassNames:function(cl){if(void 0===graph.config.dataConfig.legendOriginal||!graph.config.dataConfig.legendOriginal[graph.bydata])return cl;for(var l=graph.config.dataConfig.legendOriginal[graph.bydata].length,i=0;i<l;i++)if(graph.config.dataConfig.legendOriginal[graph.bydata][i]===cl){cl=graph.config.dataConfig.legendOverlay[graph.bydata][Lang.language][i];break}return cl},downloadCSV:function(data,suffix){let my_cvs=d3.dsv(";","text/csv");var blob=new Blob([my_cvs.format(data)],{type:"text/csv;charset=utf-8"});saveAs(blob,(suffix||"")+downloadCtrl.getProject()+"-month-"+downloadCtrl.getDownloadTime()+".csv")},setStateAnimateIcon:function(id,enable,error){document.getElementById(id).style.display="",document.getElementById(id).className=enable?"glyphicon glyphicon-refresh glyphicon-refresh-animate":"glyphicon "+(error?"glyphicon-warning-sign glyphicon-red":"glyphicon-ok glyphicon-green")},getSelectedFormatFile:function(){var opt=document.getElementById("download-option");return opt||(opt="SHAPE-ZIP"),opt[opt.selectedIndex].value},removeLittlestValues:function(sourceGroup){return{all:function(){return sourceGroup.all().filter((function(d){return Math.abs(d.value)<1e-6?0:d.value}))},top:function(n){return sourceGroup.top(1/0).filter((function(d){return Math.abs(d.value)>1e-6})).slice(0,n)}}},setTitle:function(elementId,title){elementId="title-chart-"+elementId,document.getElementById(elementId).innerHTML=this.wildcardExchange(title)},wildcardExchange:function(str){var dim="prodes"==graph.bydata?Translation[Lang.language].bydata:graph.bydata.toUpperCase();return str=str.replace(/%dim%/gi,(function(x){return dim}))},numberByUnit:function(num,displayPercent){let percent=(100*num/graph.totalFocusesGroup.value().n).toFixed(1)+"%",nf;return"\n"+localeBR.numberFormat(",")(num.toFixed(0))+" "+Translation[Lang.language].unit_focus+(displayPercent?"\n("+percent+")":"")},onResize:function(event){clearTimeout(graph.config.resizeTimeout),graph.config.resizeTimeout=setTimeout(graph.doResize,100)},getDefaultHeight:function(){return 1*(.4*window.innerHeight).toFixed(0)}},doResize:function(){graph.defaultHeight=graph.utils.getDefaultHeight(),dc.renderAll()},normalizeData:function(){var json=[];this.data.forEach((function(d){if(d.properties.b==graph.selectedBiome){let mm=+d.properties.m<10?"0"+d.properties.m:d.properties.m;var o={uf:d.properties.e,cl:d.properties.c,my:d.properties.y+"/"+mm,t:d.properties.t},auxDate=new Date(d.properties.y+"-"+mm+"-01T04:00:00.000Z");o.ts=auxDate.getTime(),json.push(o)}})),this.data=json,delete json},build:function(){let dimensions=[],focuses=crossfilter(this.data);dimensions.my=focuses.dimension((function(d){return d.my})),dimensions.ts=focuses.dimension((function(d){return+d.ts})),dimensions.uf=focuses.dimension((function(d){return d.uf})),dimensions.cl=focuses.dimension((function(d){return d.cl})),graph.utils.dimensions=dimensions;let groups=[];groups.clt=dimensions.my.group().reduce((function(p,v){return p[v.cl]=(p[v.cl]||0)+v.t,p}),(function(p,v){return p[v.cl]=(p[v.cl]||0)-v.t,p}),(function(){return"car"==graph.bydata?{Grande:0,Media:0,Pequena:0,Minifundio:0,"Sem CAR":0}:{"Desmatamento Consolidado":0,"Desmatamento Recente":0,Floresta:0,Outros:0}})),groups.uf=dimensions.uf.group().reduceSum((function(d){return+d.t})),groups.cl=dimensions.cl.group().reduceSum((function(d){return+d.t})),this.totalFocusesGroup=focuses.groupAll().reduce((function(p,v){return p.n+=v.t,p}),(function(p,v){return p.n-=v.t,p}),(function(){return{n:0}}));var htmlBox="<div class='icon-left'><i class='material-icons iconmenu hackicon'>local_fire_department</i></div><span class='number-display'>";this.totalizedFocusesInfoBox.formatNumber(localeBR.numberFormat(",")),this.totalizedFocusesInfoBox.valueAccessor((function(d){return d.n?d.n:0})).html({one:htmlBox+"<span>"+Translation[Lang.language].num_focus+" "+Translation[Lang.language].percent+"</span><br/><div class='numberinf'>%number</div></span>",some:htmlBox+"<span>"+Translation[Lang.language].num_focus+" "+Translation[Lang.language].percent+"</span><br/><div class='numberinf'>%number</div></span>",none:htmlBox+"<span>"+Translation[Lang.language].num_focus+"</span><br/><div class='numberinf'>0</div></span>"}).group(this.totalFocusesGroup),this.buildCharts(dimensions,groups)},buildCharts:function(dimensions,groups){graph.utils.setTitle("main",Translation[Lang.language].title_chart_main);let maxDate=new Date(dimensions.ts.top(1)[0].ts),minDate=new Date(dimensions.ts.bottom(1)[0].ts),dateFormat=localeBR.timeFormat("%Y/%m"),barColors=this.getOrdinalColorsClasses();function sel_stack(i){return function(d){return d.value[i]?+d.value[i]:0}}var cls=graph.config.dataConfig.legendOriginal[graph.bydata],clList=[];cls.forEach((function(d){clList.push(d)}));var my=dimensions.my.group().all();this.barMonthFiresByClass.height(.8*graph.defaultHeight).x(d3.scale.ordinal()).xUnits(dc.units.ordinal).brushOn(!1).clipPadding(10).yAxisPadding("10%").yAxisLabel(Translation[Lang.language].unit_focus).xAxisLabel(my[0].key+" - "+my[my.length-1].key).barPadding(.3).outerPadding(.1).renderHorizontalGridLines(!0).title((function(d){var t="";for(obj in d.value)d.value[obj]>0&&(t+=graph.utils.mappingClassNames(obj)+" - "+localeBR.numberFormat(",1f")(parseFloat(d.value[obj].toFixed(2)))+" "+Translation[Lang.language].unit_focus+"\n");return Translation[Lang.language].yyyymm+": "+d.key+"\n"+t})).label((function(d){var t=parseFloat(((d.y+d.y0)/1e3).toFixed(1));return t=t<1?localeBR.numberFormat(",1f")(parseFloat((d.y+d.y0).toFixed(1))):localeBR.numberFormat(",1f")(t)+"k"})).elasticY(!0).dimension(dimensions.my).group(groups.clt,clList[0],sel_stack(clList[0])).renderLabel(!0).ordinalColors("prodes"==graph.bydata?graph.palletBarChartProdes:graph.palletBarChartCar).margins({top:30,right:30,bottom:65,left:65}).legend(dc.legend().x(50).y(1).itemHeight(13).gap(7).horizontal(1).legendWidth(480).autoItemWidth(!0).legendText((function(d){var t=graph.utils.mappingClassNames(d.name);return"empty"!=d.name?t:Translation[Lang.language].without}))),delete clList[0],clList.forEach((function(clsName){graph.barMonthFiresByClass.stack(groups.clt,""+clsName,sel_stack(clsName))})),this.barMonthFiresByClass.xAxis().ticks(groups.clt.all().length),this.barMonthFiresByClass.xAxis().tickFormat((function(d){return d+""})),this.barMonthFiresByClass.yAxis().ticks(5).tickFormat((function(d){return localeBR.numberFormat(",1f")(d)})),this.barMonthFiresByClass.on("preRender",(function(chart){chart.height(.8*graph.defaultHeight),chart.legend().legendWidth(window.innerWidth/2)})),this.barMonthFiresByClass.on("renderlet.a",(function(chart){chart.selectAll("g.x text").attr("transform","translate(-20,12) rotate(315)"),chart.hasFilter()?($("#txt9a").css("display",""),$("#highlight-time").css("display","none"),$("#txt9").html(Translation[Lang.language].txt9)):($("#txt9a").css("display","none"),$("#highlight-time").css("display",""),$("#txt9").html(Translation[Lang.language].allTime),$("#highlight-time").html(" "+dateFormat(minDate)+" - "+dateFormat(maxDate)))})),graph.utils.setTitle("state",Translation[Lang.language].title_tot_state),this.ringTotalizedByState.height(graph.defaultHeight).innerRadius(10).externalRadiusPadding(10).dimension(dimensions.uf).group(this.utils.removeLittlestValues(groups.uf)).ordering(dc.pluck("value")).ordinalColors("prodes"==graph.bydata?graph.palletPieChartProdes:graph.palletPieChartCar).legend(dc.legend().x(20).y(10).itemHeight(13).gap(7).horizontal(0).legendWidth(50).itemWidth(35)),this.ringTotalizedByState.on("preRender",(function(chart){chart.height(graph.defaultHeight),chart.legend().legendWidth(window.innerWidth/2)})),this.ringTotalizedByState.title((function(d){let displayPercent=!graph.ringTotalizedByState.hasFilter();return"empty"!=d.key?d.key+": "+graph.utils.numberByUnit(d.value,displayPercent):Translation[Lang.language].without})),this.ringTotalizedByState.renderLabel(!0).minAngleForLabel(.7),this.ringTotalizedByState.label((function(d){let displayPercent=!graph.ringTotalizedByState.hasFilter();var txtLabel="empty"!=d.key?graph.utils.numberByUnit(d.value,displayPercent):Translation[Lang.language].without,f;return graph.ringTotalizedByState.hasFilter()?graph.ringTotalizedByState.filters().indexOf(d.key)>=0?txtLabel:"":txtLabel})),graph.ctlFirstLoading||dc.override(this.ringTotalizedByState,"legendables",(function(){var legendables;return this._legendables().filter((function(l){return l.data>0}))})),graph.utils.setTitle("cls",Translation[Lang.language].title_top_cls),this.histTopByCLs.height(graph.defaultHeight).dimension(dimensions.cl).group(this.utils.removeLittlestValues(groups.cl)).elasticX(!0).ordering((function(d){return-d.value})).controlsUseVisibility(!0).fixedBarHeight(!1).ordinalColors("prodes"==graph.bydata?graph.palletBarChartProdes:graph.palletBarChartCar),this.histTopByCLs.on("preRender",(function(chart){chart.height(graph.defaultHeight),chart.xAxis().ticks(chart.width()<graph.config.minWidth?4:7)})),this.histTopByCLs.xAxis().tickFormat((function(d){return d})),this.histTopByCLs.data((function(group){var fakeGroup=[];return fakeGroup.push({key:Translation[Lang.language].without,value:0}),group.all().length>0?group.top(10):fakeGroup})),this.histTopByCLs.title((function(d){let displayPercent=!graph.histTopByCLs.hasFilter();return graph.utils.mappingClassNames(d.key)+": "+graph.utils.numberByUnit(d.value,displayPercent)})),this.histTopByCLs.label((function(d){let displayPercent=!graph.histTopByCLs.hasFilter();return graph.utils.mappingClassNames(d.key)+": "+graph.utils.numberByUnit(d.value,displayPercent)})),this.histTopByCLs.colorCalculator((function(d){let cc;return barColors.find(aCor=>{if(aCor.key==d.key)return aCor.color}).color})),d3.select("#download-csv-daily-all").on("click",(function(){window.setTimeout((function(){var data=[];graph.data.forEach((function(d){var o={};o.date=d.my,o.class=d.cl,o.focuses=d.t,o.uf=d.uf,data.push(o)})),graph.utils.downloadCSV(data,"all_")}),200)})),d3.select("#download-csv-daily").on("click",(function(){window.setTimeout((function(){var data=[],filteredData;graph.utils.dimensions.uf.top(1/0).forEach((function(d){var o={};o.date=d.my,o.class=d.cl,o.focuses=d.t,o.uf=d.uf,data.push(o)})),graph.utils.downloadCSV(data)}),200)})),d3.select("#prepare_print").on("click",(function(){graph.preparePrint()})),graph.doResize(),window.onresize=this.utils.onResize,this.ctlFirstLoading=!0},preparePrint:function(){d3.select("#print_information").style("display","block"),d3.select("#print_page").on("click",(function(){d3.select("#print_information").style("display","none"),window.print()}))},configurePrintKeys:function(){Mousetrap.bind(["command+p","ctrl+p"],(function(){return console.log("command p or control p is disabled"),!1}))},restart(){graph.startLoadData()},resetFilters:function(){graph.data&&(graph.utils.dimensions.my.filterAll(),graph.utils.dimensions.ts.filterAll(),graph.utils.dimensions.uf.filterAll(),graph.utils.dimensions.cl.filterAll())}};window.onload=function(){"undefined"==typeof Authentication&&(Authentication=!1),graph.configurePrintKeys(),Lang.init(),graph.startLoadData(),Authentication&&(Authentication.serverURL="/oauth-api/",Authentication.init(Lang.language,(function(){graph.resetFilters(),graph.restart()})))};